{% extends "base.html" %}


{% block title %}: Loading...{% endblock %}


{% block main %}
    <div class="container">
        <h1>Loading games...</h1>
        <p>If you have a lot of uncommon games, this can take a while.</p>

        <div class="well well-lg">
            <p id="game_name">Starting up...</p>
            <div class="progress">
                <div id="load_bar" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0"
                     aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        $(document).ready(function () {
            // Get user data from server
            var url = '{{ url_for("user") }}?id={{ id }}';
            var data = $.getJSON(url, function() {})
                .done(function() {
                    data = data.responseJSON;

                    // Store game count in browser's local storage
                    localStorage.game_count = data.game_count;

                    // Create array to store games
                    var games = [];

                    // Iterate through games, adding info to each
                    var i;
                    var game_count = Number(data.game_count);

                    data.games.forEach(function(game) {
                        var game_url = '{{ url_for("game") }}?appid=' + game.appid;
                        var extra = $.getJSON(game_url, function() {})
                            .done(function() {
                                // Add game to array
                                var next_game = {
                                    appid: game.appid,
                                    name: game.name,
                                    description: extra.description,
                                    img_icon_url: game.img_icon_url,
                                    img_logo_url: game.img_logo_url,
                                    playtime_forever: game.playtime_forever,
                                    categories: extra.categories,
                                    ratings: extra.ratings
                                }
                                i = games.push(next_game);
                            })
                            .always(function() {
                                // Update loading bar
                                var percent = (i/game_count*100).toFixed();
                                $("#game_name").text(game.name + ' (' + i + '/' + game_count + ')');
                                $("#load_bar").css('width', percent + '%');
                                $("#load_bar").attr("aria-valuenow", percent);

                                if (i == game_count) {
                                    // Store games in local storage when all are loaded in
                                    localStorage.games = JSON.stringify(games);
                                    console.log("Games Stored!")
                                }
                                // Increment game counter
                                i++;
                            })
                    })
                })
                .fail(function() {
                    console.log("Couldn't get user data.");
                    window.location = '{{ url_for("error") }}';
                })
        });
    </script>
{% endblock %}
